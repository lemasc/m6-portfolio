---
title: วิทยุเสียงตามสาย PM Station
description: เว็บไซต์สำหรับโครงการ PM Station เพื่อให้นักเรียนสามารถส่งคำขอเพลงเข้าสู่รายการวิทยุเสียงตามสาย โดยการเชื่อมต่อกับ Spotify API เพื่อค้นหาในคลังเพลงได้
releaseDate: 2022-09-06
tags:
  - year 2565
  - website
  - student-council
image: https://raw.githubusercontent.com/coolkidssatit/pm-station/main/screenshots/pm-station-songrequests-search.png
gitUrl: https://github.com/coolkidssatit/pm-station
rating: 5
---

import ResponsiveBanner from "../../../components/Markdown/ResponsiveBanner";

โครงการวิทยุเสียงตามสาย PM Station เป็นโครงการจากคณะกรรมการนักเรียนฝ่ายเทคโนโลยีสารสนเทศ ประจำปีการศึกษา 2565
โดยมีวัตถุประสงค์เพื่อ

- ใช้เป็นช่องทางการประชาสัมพันธ์ข้อมูลข่าวสารของโรงเรียน
- ทำให้บรรยากาศช่วงเช้าภายในโรงเรียนมีสีสันมากยิ่งขึ้น
- เปิดโอกาสให้นักเรียนที่มีความสนใจในการจัดรายการวิทยุได้ฝึกฝนทักษะในด้านนี้

โดยดำเนินการในรูปแบบของการจัดรายการวิทยุเสียงตามสาย ณ ห้องประชาสัมพันธ์ โดยจัดตั้งแต่วันที่ 8 กันยายน 2565 เป็นต้นมา
ซึ่งได้มีการพัฒนาเว็บไซต์มาช่วยในการจัดรายการวิทยุให้มีประสิทธิภาพมากยิ่งขึ้น

## ที่มาของผลงาน

ในรายการวิทยุเสียงตามสาย องค์ประกอบที่สำคัญองค์ประกอบหนึ่งนั่นก็คือ **เพลง** สำหรับเปิดในรายการ
ซึ่งในการรับคำขอเพลงเดิมน้้นจะใช้วิธีการต่าง ๆ เช่น เลือกโดยผู้จัดรายการเอง ให้นักเรียนส่งคำขอมาทางช่องทางโซเชียล
หริอกระทั่งให้นักเรียนหรือบุคคลที่สนใจมาส่งคำขอเพลงโดยตรงที่ห้องประชาสัมพันธ์เป็นต้น ซึ่งในแต่ละวิธีการก็มีข้อเสียต่าง ๆ เช่น

- **เลือกโดยผู้จัดรายการเอง** เพลงที่เปิดจากผู้จัดรายการอาจไม่มีความหลากหลาย นักเรียนซึ่งเป็นผู้ฟังไม่ได้มีส่วนร่วมการเลือกเพลง
- **ส่งคำขอทางช่องทางโซเชียล** คำขอเพลงที่ส่งเข้ามาอาจไม่มีความเป็นระเบียบเรียบร้อย รวบรวมและนำไปใช้ต่อได้ยาก
- **ส่งคำขอเพลงโดยตรงที่ห้องประชาสัมพันธ์** อาจรบกวนการจัดรายการของผู้จัดรายการในขณะนั้น

ผมจึงมีแนวคิดที่จะจัดทำเว็บไซต์สำหรับจัดการคำขอเพลงในรายการโดยเฉพาะ โดยตั้งอยู่บนหลักการสำคัญ 3 ข้อด้วยกัน

1. **ระบบจะต้องสามารถใช้งานได้ง่าย** มีรูปแบบการใช้งานที่เรียบง่าย เพื่อให้สามารถใช้งานได้กับทุกคน
2. **สามารถรวบรวมและนำเพลงไนระบบไปใช้ได้ต่อได้** ผู้จัดรายการจะต้องสามารถเรียกดูรายการคำขอเพลงที่ส่งเข้ามาได้ และสามารถนำเพลงไปค้นหาหรือเปิดต่อได้
3. **สามารถปฏิเสธเพลงที่ไม่เหมาะสมในระบบได้** การคัดกรองเนื้อหาก่อนจัดรายการมีความสำคัญมาก หากเพลงใดที่มีเนื้อหาไม่เหมาะสม ต้องสามารถปฏิเสธในระบบได้

## หลักการทำงาน

โครงการ PM Station เขียนด้วยภาษา TypeScript เป็นหลัก มีลักษณะของ Project เป็น Monorepo มีส่วนประกอบดังต่อไปนี้

### ส่วนที่ 1 การจัดการคำขอเพลง

![PM Station - Songrequests](https://raw.githubusercontent.com/coolkidssatit/pm-station/main/screenshots/pm-station-songrequests-search.png)

ส่วนการจัดการคำขอเพลง เป็นส่วนประกอบหลักของ Project นี้ จัดทำเป็นเว็บไซต์โดยใช้ React Framework เป็น Remix
และเผยแพร่เว็บไซต์นี้ผ่านทางแพลตฟอร์ม Fly.io และ Vercel
เว็บไซต์นี้ทำหน้าที่รับคำขอเพลงจากผู้ใช้งาน และจัดการคำขอเพลงที่ได้รับโดยผู้จัดรายการและบุคคลที่เกี่ยวข้อง

เว็บไซต์ในส่วนนี้เริ่มใช้งานตั้งแต่วันเริ่มต้นโครงการ (6 กันยายน 2565) และยังคงมีการปรับปรุงแก้ไขฟีเจอร์ต่าง ๆ อยู่อย่างต่อเนื่อง โดยเปิดให้สามารถใช้งานได้ทั้งนักเรียน บุคลากรในโรงเรียน และบุคคลภายนอก

<ResponsiveBanner />

#### 1. การเข้าสู่ระบบ

เว็บไซต์นี้ใช้ **Firebase Authentication** เป็นระบบตรวจสอบสิทธิ์ผู้ใช้งาน โดยตั้งค่าให้สามารถเข้าสู่ระบบโดยใช้หมายเลขโทรศัพท์ (Phone Login) ได้ ซึ่ง Firebase มีโควตาการใช้งานฟรี ทำให้ไม่เสียค่าใช้จ่ายแต่อย่างใด

เมื่อผู้ใช้งานเข้าสู่เว็บไซต์ จะปรากฏหน้าสำหรับป้อนเบอร์โทรศัพท์ และรับรหัส OTP ดังรูป

![PM Station - Login](/images/projects/pm-station/login.png)

เมื่อเข้าสู่ระบบสำเร็จแล้ว ในครั้งแรกจะให้ผู้ใช้งานลงทะเบียนข้อมูลก่อน โดยประกอบด้วยชื่อ (`displayName`) และประเภทของผู้ใช้ (`type`) ส่วนตำแหน่งของผู้ใช้ (`role`) จะถูกตั้งค่าเริ่มต้นเป็นผู้ใช้งาน (User) ดังรูป

![PM Station - Profile](/images/projects/pm-station/profile.png)

ประเภทและตำแหน่งของผู้ใช้ในระบบมีรายการดังต่อไปนี้

- ผู้ใช้งาน (User)
- ผู้จัดรายการ (Editor)
- ผู้ดูแล (Moderator)
- ผู้ดูแลระบบ (Admin)

ข้อมูลที่ได้จากการลงทะเบียนจะถูกจัดเก็บลงใน Token ของ Firebase Authentication ด้วย [Custom Claims](https://firebase.google.com/docs/auth/admin/custom-claims)
ซึ่งต่างจากผลงานชิ้นอื่น ๆ ที่มักจัดเก็บลงในฐานข้อมูลภายนอกอย่าง Firebase Firestore เนื่องจาก Remix นั้นเป็น React Framework ที่เน้นการ Render Page แบบ Server Side Rendering จึงต้องลดการเชื่อมต่อไปยังฐานข้อมูลโดยไม่จำเป็น

#### 2. การส่งคำขอเพลง

เมื่อผู้ใช้งานได้เข้าสู่ระบบแล้ว สามารถส่งคำขอเพลงสำหรับเปิดในรายการเข้าสู่ระบบได้ โดยในขณะทีพัฒนาเว็บไซต์นี้มีทางเลือกในการออกแบบฟีเจอร์นี้ 2 วิธี

1. **รับคำขอเพลงจากลิงก์ของผู้ให้บริการสตรีมมิง (เช่น YouTube)** วิธีการนี้ผู้ใช้งานจะต้องค้นหาเพลงในผู้ให้บริการภายนอก แล้วคัดลอกลิงก์มายังเว็บไซต์ แล้วเว็บไซต์จึงเรียกดูข้อมูลผ่านทาง API (เช่น Youtube Data API)
2. **ค้นหาเพลงในระบบผ่านทาง API ของผู้ให้บริการสตรีมมิง (เช่น Spotify)** วิธีการนี้เราสามารถกำหนดรูปแบบการแสดงผลในส่วนของการค้นหาได้ตามต้องการ ไม่จำเป็นต้องให้ผู้ใช้งานเปลี่ยนเว็บไซต์ไปยังผู้ให้บริการภายนอก

ผมได้เลือกวิธีการที่ 2 โดยเลือกเป็นผู้ให้บริการจาก Spotify ซึ่งนอกจากเหตุผลในการค้นหารายการเพลงแล้ว เหตุผลอีกข้อหนึ่งก็คือ การรับคำขอจากลิงก์ของผู้ให้บริการอย่าง YouTube ที่มีคลิปวิดีโอและเพลงจำนวนมากเป็นการเปิดอิสระแก่ผู้ใช้งานก็จริง แต่ก็ทำให้การคัดกรองเพลงนั้นยากขึ้นเช่นเดียวกัน

ส่วนติดต่อให้ผู้ใช้งานสามารถค้นหาเพลงและส่งคำขอเพลงได้จากภายในเว็บไซต์มีลักษณะดังนี้

<video
  autoPlay={false}
  src="/images/projects/pm-station/songrequests-search.mp4"
  title="PM Station - Songrequests Search"
/>

ผู้ใช้งานสามารถค้นหาเพลงที่ต้องการได้ จากนั้นเลือกเพลงที่ต้องการ สามารถทดลองฟังโดยการกด Preview ได้ และกดปุ่ม **"ส่งคำขอเพลง"** เพื่อส่งคำขอเพลงไปยังระบบได้

ในการส่ง Request ไปยัง Spotify API นั้นมีการ Authorization ด้วย Access Token จึงมีการเขียนคำสั่งในส่วนนี้ไว้ด้วย โดยมี Diagram ดังต่อไปนี้

![Spotify Authorization Flow - Client Credentials](https://developer.spotify.com/images/documentation/web-api/auth-client-credentials.png)

เพื่อลดจำนวนครั้งในการ Request Token ใหม่ในแต่ละครั้ง ผมจึงออกแบบให้สามารถจัดเก็บ Token ไว้ใน Redis เพื่อเป็นการ Caching และกำหนดให้ใช้ Token นี้หากยังไม่หมดอายุ
โดย Token นี้จะถูกจัดเก็บไว้ใน Upstash Redis ซึ่งเป็น Redis แบบ Serverless และมีโควตาการใช้งานฟรี ทำให้ไม่เสียค่าใช้จ่ายอีกเช่นกัน

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/utils/pm-station/spotify/auth.ts#L36-L65
```

หลักการทำงานของหน้าค้นหานี้คือการเรียกใช้ Spotify API เพื่อค้นหาเพลงโดยใช้ Endpoint [`/search`](https://developer.spotify.com/documentation/web-api/reference/search) ที่สามารถค้นหาได้จากชื่อเพลง หรือชื่อศิลปินก็ได้

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/utils/pm-station/spotify/search.ts#L41-L55
```

เมื่อผู้ใช้งานกดส่งคำขอเพลง ระบบจะบันทึกคำขอนี้ไว้ในฐานข้อมูล Firebase Firestore โดยบันทึกข้อมูล 2 ประเภทดังต่อไปนี้
เมื่อ `trackId` หมายถึงรหัส ID ของรายการเพลงจาก Spotify API และ `userId` หมายถึงรหัส ID ของผู้ใช้งานจาก Firebase Authentication

- **ข้อมูลเพลง (Record)** อยู่ที่ตำแหน่ง `songrequests/{trackId}` บันทึกข้อมูลเพลงที่ได้รับจาก Spotify API และเพิ่มเติมข้อมูลต่าง ๆ ที่จำเป็น
  เช่น จำนวนผู้ส่งคำขอ (`submissionCount`) วันที่เล่นล่าสุด (`lastPlayedAt`) เป็นต้น

```
https://github.com/coolkidssatit/pm-station/blob/main/packages/pm-station-shared/schema/src/songrequests/schema.ts#L12-L35
```

- **ข้อมูลการส่งคำขอ (Submission)** อยู่ที่ตำแหน่ง `songrequests/{trackId}/submission/{userId}` บันทึกรายการคำขอเพลงจากผู้ใช้ ประกอบด้วยข้อมูลที่จำเป็น
  เช่น ส่งคำขอโดยใคร (`submittedBy`) เป็นต้น

```
https://github.com/coolkidssatit/pm-station/blob/main/packages/pm-station-shared/schema/src/songrequests/schema.ts#L37-L41
```

จะสังเกตได้ว่าผลงานนี้ผมเริ่มมีการนำ Schema Library คือ [`zod`](https://zod.dev/) มาช่วยในการตรวจสอบข้อมูลว่ามีโครงสร้างตามที่กำหนดไว้หรือไม่ แทนที่จะใช้ Type Interface โดยตรง ซึ่งวิธีการนี้ทำให้เว็บไซต์มีความเสถียรขึ้นมาก เนื่องจาก Schema Library จะแสดง Error ทันทีหากข้อมูลไม่เป็นไปตามโครงสร้างที่เรากำหนด สามารถแก้ไขข้อบกพร่องต่าง ๆ ได้รวดเร็ว

สำหรับข้อมูลที่เกี่ยวกับการนับจำนวน และวันที่ ผมได้ใช้ Firebase Functions ในการกำหนดค่าเมื่อ Collection มีการเปลี่ยนแปลงโดยอัตโนมัติ เพื่อให้ได้ข้อมูลที่เป็นปัจจุบันมากที่สุด
และป้องกันข้อมูลบางรายการที่ส่งจากผู้ใช้งานซ้ำซ้อนกัน (Duplication)

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/pm-station-firebase/functions/src/handler.ts#L24-L48
```

โค้ดด้านบนนี้เป็นตัวอย่างใน Firebase Functions ที่จะดำเนินการดังต่อไปนี้เมื่อข้อมูลการส่งคำขอ (Submission) เปลี่ยนแปลงไป

- กำหนดเวลาที่แก้ไขล่าสุด (`lastUpdatedAt`) และจำนวนผู้ส่งคำขอทั้งหมดของเพลงที่ผู้ใช้งานส่งเข้าในระบบ
- กำหนดจำนวนคำขอสุทธิ (`submissionCount`) ลงใน Document `summary` ซึ่งบันทึกรายการสรุปของรายการคำขอและเพลงทั้งหมด

#### 3. การจัดการคำขอเพลง

ผู้ที่มีตำแหน่งผู้ใช้ตั้งแต่ Editor ขึ้นไป สามารถดูรายการคำขอเพลงจากผู้ใช้งานที่ส่งเข้ามาได้ เดิมทีข้อมูลในส่วนนี้ใช้การแสดงผลจากฐานข้อมูล Firebase Firestore เพียงอย่างเดียว ซึ่งสามารถจัดเรียง (Sort) และคัดกรองข้อมูล (Filter) ได้อย่างง่าย ๆ เท่านั้น แต่ต่อมาเมื่อรายการคำขอเพลงมีจำนวนมากขึ้น จึงมีการประยุกต์ใช้บริการ Search Engine จาก Algolia เพื่อให้สามารถค้นหาข้อมูลแบบ Full Text Search ได้ด้วย

การใช้งาน Algolia ร่วมกับ Firebase Firestore นั้น สามารถทำได้โดยการติดตั้งส่วนเสริม [Search with Algolia](https://extensions.dev/extensions/algolia/firestore-algolia-search) ซึ่งมีค่าใช้จ่ายในส่วนนี้เพียงเล็กน้อยเท่านั้น

ปัจจุบันส่วนการจัดการคำขอเพลงมีความสามารถดังต่อไปนี้

- จัดเรียงคำขอเพลงตาม "ชื่อ" หรือ "วัน-เวลาส่ง" ได้
- จัดเรียงคำขอเพลงตามสถานะ "ยังไม่ได้เล่น" "เล่นแล้ว" หรือ "ถูกปฏิเสธ" ได้

<video
  src="/images/projects/pm-station/songrequests-editor-overview.mp4"
  title="PM Station - Songrequests Editor (Sort)"
/>

- ปฏิเสธหรือยกเลิกการปฏิเสธเพลงที่เนื้อหาไม่เหมาะสมได้

<video
  src="/images/projects/pm-station/songrequests-editor-reject.mp4"
  title="PM Station - Songrequests Editor (Reject)"
/>

- สามารถค้นหาคำขอเพลงที่ต้องการได้ด้วยชื่อเพลง หรือชื่อศิลปินได้
- สามารถคัดกรองคำขอเพลงได้ตามจำนวนคำขอเพลง หรือศิลปินได้

<video
  src="/images/projects/pm-station/songrequests-editor-filter.mp4"
  title="PM Station - Songrequests Editor (Filter)"
/>

ส่วนติดต่อในหน้านี้มีการประยุกต์ใช้ [React InstantSearch](https://www.algolia.com/doc/guides/building-search-ui/what-is-instantsearch/react-hooks/) ซึ่งเป็นชุด Components สำหรับออกแบบส่วนติดต่อการค้นหาและกรองข้อมูลจาก Algolia ทำให้สามารถประหยัดเวลาในการเขียนโค้ดไปได้มาก

#### 4. การจัดการรายการเพลง

ในการจัดรายการวิทยุเสียงตามสาย จะต้องมีรายการเพลง (Playlist) สำหรับเปิดในแต่ละวันที่จัด ซึ่งในระบบสามารถเลือกเพลงจากรายการคำขอเพลงมาจัดเป็น Playlist ได้

![PM Station - Playlist Editor](/images/projects/pm-station/playlist-editor-view.png)

ผู้ที่มีตำแหน่งผู้ใช้ตั้งแต่ Editor ขึ้ันไปสร้างและจัดการรายการเพลงสำหรับรายการวิทยุของตนเองได้ ส่วนผู้ที่มีตำแหน่งผู้ใช้ตั้งแต่ Moderator ขึ้นไปสามารถจัดการรายการเพลงสำหรับรายการวิทยุทุกรายการได้

ในแบบฟอร์มสำหรับเลือกเพลงมาจัดใน Playlist นั้น สามารถเลือกเพลงมาจัดได้ 2 วิธี

- **เลือกจากหน้าคำขอเพลง** เว็บไซต์จะเปิดหน้าป๊อปอัพขึ้นใหม่ สำหรับเลือกคำขอเพลงที่ต้องการเข้าสู่ Playlist

<video
  src="/images/projects/pm-station/playlist-editor-song-select.mp4"
  title="PM Station - Playlist Editor (Select Song)"
/>

- **สุ่มเพลง** หากไม่ต้องการเลือกจากหน้าคำขอเพลง สามารถสุ่มเพลงได้ โดยระบบจะสุ่ม ID หรือชื่อของเพลงแล้วนำไปค้นหากับฐานข้อมูล Firebase Firestore ว่ามีเพลงที่ใกล้เคียงหรือไม่

<video
  src="/images/projects/pm-station/playlist-editor-song-random.mp4"
  title="PM Station - Playlist Editor (Random Song)"
/>

ในการส่งข้อมูลระหว่างหน้าแก้ไขรายการเพลงและหน้าสำหรับเลือกเพลงใช้ [BroadcastChannel](https://developer.mozilla.org/en-US/docs/Web/API/BroadcastChannel) ซึ่งเป็น API สำหรับส่งข้อมูลระหว่างแท็บภายใต้โดเมนเดียวกัน (same origin) เริ่มต้นจากในหน้าแก้ไขรายการเพลง ให้เปิดป๊อปอัพสำหรับหน้าเลือกเพลงก่อน

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/components/PlaylistEditor/SelectTrack.tsx#L26-L32
```

ที่หน้าป๊อปอัพสำหรับเลือกเพลง ให้สร้าง BroadcastChannel สำหรับส่งข้อมูลเมื่อเพลงถูกเลือกโดยผู้ใช้งาน

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/components/TrackModal/commands/AddToPlaylist.tsx#L16-L43
```

จากนั้นที่หน้าแก้ไขรายการเพลง ให้สร้าง BroadcastChannel สำหรับรับข้อมูลและเพิ่ม ID ของเพลงที่ยังไม่มีในรายการ

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/components/PlaylistEditor/SelectTrack.tsx#L9-L24
```

ทั้ง 2 หน้าจึงสามารถสื่อสารและส่งข้อมูลระหว่างกันได้ ซึ่ง BroadcastChannel เป็นการสื่อสารแบบสองทาง (Two-way communication) จึงสามารถส่งข้อมูลกลับไปได้อีกด้วย

### ส่วนที่ 2 การแสดงสถานะเพลงในระหว่างการจัดรายการ

ส่วนการแสดงสถานะเพลง เป็นส่วนประกอบที่เพิ่มเติมจากการจัดการคำขอเพลง จัดทำเป็นเว็บไซต์โดยใช้ React Framework เป็น Next.js และเผยแพร่เว็บไซต์นี้ผ่านทางแพลตฟอร์ม Fly.io (Server) และ Vercel (Website) เว็บไซต์นี้จะทำหน้าที่แสดงรายการเพลงที่เปิดอยู่ในขณะจัดรายการออกสู่จอทีวีของโรงเรียน และในอนาคตอาจเพิ่มเติมการแสดงผลข้อมูลอื่น ๆ ที่เป็นประโยชน์อีกด้วย

ระบบในส่วนนี้เริ่มทดลองใช้ตั้งแต่วันที่ 4 มกราคม 2566 และใช้กันภายในคณะกรรมการนักเรียนเท่านั้น ไม่ได้มีการเผยแพร่และประชาสัมพันธ์แต่อย่างใด

หลักการทำงานของส่วนที่ 2 นี้คือ [Websocket](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API) ซึ่งเป็น Protocol สำหรับเชื่อมต่อและสื่อสารแบบสองทาง (Two-way communication) โดยจะมีองค์ประกอบดังต่อไปนี้

1. **อุปกรณ์สำหรับควบคุมเพลง (Controller)** อาจเป็นคอมพิวเตอร์หรืออุปกรณ์เคลื่อนที่ก็ได้ ทำหน้าที่เลือกและควบคุมการเล่นเพลงปัจจุบัน
2. **จอแสดงผล (Projector)** รับข้อมูลการแสดงผลจาก Controller และแสดงรายการเพลงที่เล่นอยู่ในปัจจุบัน จอแสดงผลนี้จะเปิดไว้ตลอดระยะเวลาของรายการ
3. **Websocket Server** ทำหน้าที่เป็นตัวกลางในการรับและส่งข้อมูลไปยังทั้ง 2 อุปกรณ์ข้างต้น

ทั้ง 3 องค์ประกอบนี้เขียนโดยใช้ภาษา TypeScript โดยใช้ [Socket.io](https://socket.io/) ซึ่งเป็น Library สำหรับสร้างและเชื่อมต่อ Websocket ทั้งฝั่ง Server และ Client และเนื่องจากมีการวางโครงสร้างของ Project นี้เป็น Monorepo จึงสามารถใช้โค้ดร่วมกันได้จากทั้ง 2 ส่วนอีกด้วย ลดความซับซ้อนและข้อผิดพลาดไปได้มาก

ผู้จัดรายการเพลงจำเป็นต้องสร้างรายการเพลง (Playlist) ในวันที่จะจัดรายการล่วงหน้าก่อนเสมอ

#### การเล่นเพลง (Music Streaming)

ในการแสดงสถานะเพลง ระบบจำเป็นต้องมีข้อมูลการเล่นเพลงปัจจุบัน ซึ่งหมายถึงการออกแบบโปรแกรมเล่น (Player) ภายในเว็บไซต์ด้วย โจทย์แรกคือเราจะสามารถเล่นเพลงจากรายการคำขอเพลงที่จัดไว้ได้อย่างไร

ในแต่ละเพลงจะมี Spotify Track ID สำหรับนำไปเปิดผ่านแอพลิเคชัน Spotify อยู่แล้ว และ Spotify ก็มี [Web Playback SDK](https://developer.spotify.com/documentation/web-playback-sdk) สำหรับสร้างโปรแกรมเล่นด้วย แต่การจะเล่นเพลงจาก Spotify นั้นจำเป็นต้องมีการสมัครสมาชิก Premium (ซึ่งยังไม่มี 😥) จึงต้องเปลี่ยนการเล่นเพลงไปเป็น YouTube แทน เนื่องจากมี Library ที่รองรับมากกว่า แต่เราจะเล่นเพลงใน YouTube ด้วยเพลงจาก Spotify ได้อย่างไร

ที่เว็บไซต์หลักจึงมีการเพิ่มเติมฟีเจอร์ **"ซิงก์เพลง"** ในส่วนของการจัดการรายการเพลงด้วย โดยหลักการของการซิงก์เพลงนั้นคือ การค้นหาลิงก์คลิปวิดีโอ YouTube ของเพลงใน Spotify ที่เลือก

<video
  src="/images/projects/pm-station/playlist-editor-sync.mp4"
  title="PM Station - Playlist Editor (Sync Playlist)"
/>

YouTube มีแพลตฟอร์มสริมมิงเพลงของตนเองคือ YouTube Music ซึ่งมีคลังเพลงในลักษณะเดียวกันกับ Spotify แต่เนื่องจาก YouTube Music ไม่มี API อย่างเป็นทางการให้ใช้งาน จึงเลือกใช้ Library [`node-youtube-music`](https://github.com/baptisteArno/node-youtube-music) ที่มีการ Reverse Engineer API ภายในของ YouTube ในการค้นหาเพลงด้วยข้อมูลเพลงจาก Spotify

เริ่มจากการสร้างคำค้นหาสำหรับค้นหาบน Youtube Music ในที่นี้คือการใช้ชื่อศิลปิน ควบคู่กับชื่อเพลง เพื่อให้ได้เพลงที่ถูกต้องแม่นยำมากยิ่งขึ้น

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/components/TrackModal/sync/index.tsx#L21
```

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/components/TrackModal/sync/index.tsx#L24-L27
```

ในฝั่งของเซิร์ฟเวอร์ เนื่องจาก YouTube Music API จะส่งผลลัพธ์จากการค้นหา 20 รายการแรก ระบบจึงเลือกเพลงแรกสุด และส่งข้อมูล ได้แก่ ชื่อเพลง ศิลปิน ระยะเวลา รูปปก (Art Cover) ของเพลง และลิงก์ YouTube ของวิดีโอกลับไปยังผู้ใช้งาน

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/utils/pm-station/ytmusic/index.ts#L10-L35
```

โดยส่วนมากข้อมูลเพลงเมื่อเผยแพร่ลงบนแพลตฟอร์มสตรีมมิง จะใช้ข้อมูลชุดเดียวกัน เช่น ใช้ชื่อเพลง และรูปปก (Art Cover) เดียวกัน ทำให้สามารถเปรียบเทียบกันได้ง่ายว่าการค้นหาอัตโนมัตินั้นถูกต้องหรือไม่ อย่างไรก็ตาม เพลงที่เลือกจากระบบก็มีโอกาสที่จะไม่ถูกต้อง จึงอนุญาตให้มีการแก้ไข URL ของเพลงที่ถูกต้องได้ แต่เมื่อกดบันทึกข้อมูลแล้วจะไม่สามารถแก้ไขได้อีก

<video
  src="/images/projects/pm-station/playlist-editor-sync-edit-url.mp4"
  title="PM Station - Playlist Editor (Sync Playlist - Edit URL)"
/>

### การแสดงผลเพลงที่กำลังเล่นปัจจุบัน

<video
  autoPlay={false}
  src="/images/projects/pm-station/kiosk-player.mp4"
  title="PM Station - Kiosk Player"
/>

ผมได้มีการออกแบบส่วนติดต่อในฝั่ง Controller ให้เป็นระบบคิวเพลง ที่สามารถเลือกเพลงจากรายการเพลงเข้าไปยังคิวเพลงเพื่อรอเล่นได้

หลักการจริง ๆ ในส่วนนี้ไม่มีอะไรซับซ้อนมากนัก ทั้ง 2 อุปกรณ์ (Controller และ Projector) เชื่อมต่อเข้าสู่ Websocker Server

- Controller จะสามารถเรียกคำสั่งพื่อส่งข้อมูลไปยังเซิร์ฟเวอร์ได้ 2 คำสั่ง คือ `play` และ `stop`

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/kiosk-socket/types/socket/controller.ts#L3-L6
```

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/kiosk-web/app/controller/app/components/PlayerContext.tsx#L97-L111
```
- Websocket Server เมื่อได้รับคำสั่งจาก Controller จะส่งต่อข้อมูลไปยัง Projector

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/kiosk-socket/server/controller.ts#L13-L38
```

- Projector เมื่อได้รับข้อมูลแล้วจะบันทึกลงใน State เพื่อแสดงผลบนจอ

```
https://github.com/coolkidssatit/pm-station/blob/main/apps/kiosk-web/store/projector/socket.ts#L18-L30
```

## ผลตอบรับจากการทำผลงาน

จากข้อมูลผู้ใช้งานที่ลงทะเบียนในระบบ 196 บัญชี สามารถสรุปเป็นข้อมูลการเข้าใช้งานเว็บไซต์ในปีการศึกษา 2565 ตั้งแต่วันที่ 6 กันยายน 2565 - 1 มีนาคม 2566 ได้ดังนี้

![PM Station - Submission Graph](/images/projects/pm-station/graph-submission.png)

**จำนวนคำขอเพลง** หมายถึงจำนวนคำขอเพลงที่ได้รับจากผู้ใช้งาน **จำนวนเพลง** หมายถึงจำนวนเพลงที่ได้รับจากคำขอของผู้ใช้งาน โดยไม่นับคำขอเพลงที่ซ้ำกัน

จากกราฟ สามารถนำมาวิเคราะห์ข้อมูลดังนี้

- มีจำนวนคำขอเพลงรวมทั้งสิ้น 967 คำขอ จำนวนเพลง 800 เพลง
- ช่วงเดือนกันยายนซึ่งเป็นช่วงเริ่มต้นของการประชาสัมพันธ์ มีผู้ส่งคำขอเพลงเข้าในระบบเป็นจำนวนมาก
- ช่วงเดือนตุลาคมเป็นช่วงปิดเทอม จำนวนการส่งคำขอเพลงลดลง
- ช่วงเดือนธันวาคมเป็นช่วงที่มีวันหยุดราชการและกจกรรมกีฬาสีที่ทำให้ไม่มีการเรียนการสอน จำนวนคำขอเพลงจึงลดลง
- ผู้ใช้งานส่วนมากเมื่อเข้าเว็บไซต์แล้วจะส่งคำขอเพลง

สำหรับการจัดรายการเพลงจากคำขอเพลง มีเพลงที่ได้จัดรายการในปีการศึกษา 2565 นี้ รวมแล้ว 133 เพลง คิดเป็น 16% ของเพลงทั้งหมด

ในแง่ของจำนวนผู้ใช้งาน มีจำนวนผู้ใช้งานที่ส่งคำขอเพลงอย่างน้อย 1 เพลง 172 คน จำนวนการส่งคำโดยเฉลี่ยของแต่ละผู้งานอยู่ที่ 5 คำขอ จำนวนคำขอเพลงที่ส่งโดยผู้ใช้งานมากที่สุดคือ 115 เพลง

## สิ่งที่ได้เรียนรู้จากการทำผลงาน

ผลงานนี้เปลี่ยนรูปแบบการเขียนเว็บไซต์ต่างจากเดิม เปลี่ยน React Framework จาก Next.js มาเป็น Remix ซึ่งเป็น Framework ที่เน้นการ Render Page แบบ Server Side Rendering ทำให้ต้องเปลี่ยนวิธีการคิดและออกแบบจากเดิมที่อยู่ในฝั่ง Client มาอยู่ในฝั่ง Server มากขึ้น (ซึ่งเป็นเรื่องดี) นอกจากนี้ได้เปลี่ยน Deploy Platform จาก Vercel และ Netlify มาเป็น Fly.io ด้วย ซึ่งไม่ใช่แพลตฟอร์มแบบ Serverless แล้ว มีการประมวลผลด้วย Server จริง ๆ จึงต้องจัดสรรทรัพยากรการใช้งานให้เหมาะสม ไม่มากจนเกินไป และฝึกการตั้งค่า Docker เพื่อใช้กับ Fly.io อีกด้วย

## ปัญหาและอุปสรรคที่เกิดขึ้น

Fly.io เป็นแพลตฟอร์มแบบ Container-based ซึ่งเน้นการใช้ Docker เป็นหลัก Fly.io นั้นไม่มีระบบ CI สำหรับ Deploy อัตโนมัติแล้ว จึงต้องเขียน Github Actions ซึ่งเป็น CI บน Github เองอีกด้วย

การใช้งาน Container อย่าง Docker ต้องใช้ความแรงของคอมพิวเตอร์ระดับหนึ่ง ในช่วงที่กำลังพัฒนา คอมพิวเตอร์ที่ใช้ยังมีประสิทธิภาพไม่แรงมาก การ Build ในแต่ละครั้งจึงใช้เวลาค่อนข้างนาน ประกอบกับการ Debug หรือแก้ไขปัญหาเมื่อเกิดข้อผิดพลาดนั้นสามารถทำได้ยาก เวลาบางส่วนในการพัฒนาจึงเสียไปกับการ Setup เหล่านี้ ซึงถ้าหาก Deploy บนแพลตฟอร์มเดิมอย่าง Vercel กระบวนการจะไวขึ้นมาก แต่ขณะนั้น Vercel ยังไม่รองรับ Remix อย่างเต็มรูปแบบล

นอกจากนี้ เมื่อใช้แพลตฟอร์มแบบ Container-based แล้ว การจัดสรรทรัพยากร เช่น CPU และ RAM จึงมีความสำคัญมาก ๆ ด้วย ้เกิดเหตุการณ์ที่เมื่อทดสอบบนคอมพิวเตอร์ส่วนตัวสามารถทำงานได้ แต่บนเซิร์ฟเวอร์กลับมีปัญหา เนื่องจากการจัดสรรทรัพยากรไม่เพียงพอ แพลนแบบฟรีของ Fly.io จะใช้ CPU แบบ shared และ RAM 256MB ซึ่งสามารถใช้รันเว็บไซต์ขนาดเล็กได้ แต่สำหรับส่วนที่ 2 การแสดงสถานะเพลงนั้นมีการรัน Websocket Server ด้วย ทำให้การจัดสรร RAM ไม่เพียงพอ ประกอบกับเหตุการณ์ในการ Debug ที่กล่าวมาแล้วข้างต้นทำให้เสียเวลาแก้ปัญหาส่วนนี้พอสมควร
