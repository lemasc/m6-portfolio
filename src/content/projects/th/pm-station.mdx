---
title: วิทยุเสียงตามสาย PM Station
description: เว็บไซต์สำหรับโครงการ PM Station เพื่อให้นักเรียนสามารถส่งคำขอเพลงเข้าสู่รายการวิทยุเสียงตามสาย โดยการเชื่อมต่อกับ Spotify API เพื่อค้นหาในคลังเพลงได้
releaseDate: 2022-09-06
tags:
  - year 2565
  - website
  - student-council
image: https://raw.githubusercontent.com/coolkidssatit/pm-station/main/screenshots/pm-station-songrequests-search.png
gitUrl: https://github.com/coolkidssatit/pm-station
rating: 5
---

import GithubEmbed from "@/components/markdown/GithubEmbed.astro";
import ResponsiveBanner from "@/components/markdown/ResponsiveBanner.astro";

โครงการวิทยุเสียงตามสาย PM Station เป็นโครงการจากคณะกรรมการนักเรียนฝ่ายเทคโนโลยีสารสนเทศ ประจำปีการศึกษา 2565
โดยมีวัตถุประสงค์เพื่อ

- ใช้เป็นช่องทางการประชาสัมพันธ์ข้อมูลข่าวสารของโรงเรียน
- ทำให้บรรยากาศช่วงเช้าภายในโรงเรียนมีสีสันมากยิ่งขึ้น
- เปิดโอกาสให้นักเรียนที่มีความสนใจในการจัดรายการวิทยุได้ฝึกฝนทักษะในด้านนี้

โดยดำเนินการในรูปแบบของการจัดรายการวิทยุเสียงตามสาย ณ ห้องประชาสัมพันธ์ โดยจัดตั้งแต่วันที่ 8 กันยายน 2565 เป็นต้นมา
ซึ่งได้มีการพัฒนาเว็บไซต์มาช่วยในการจัดรายการวิทยุให้มีประสิทธิภาพมากยิ่งขึ้น

## ที่มาของผลงาน

ในรายการวิทยุเสียงตามสาย องค์ประกอบที่สำคัญองค์ประกอบหนึ่งนั่นก็คือ **เพลง** สำหรับเปิดในรายการ
ซึ่งในการรับคำขอเพลงเดิมน้้นจะใช้วิธีการต่าง ๆ เช่น เลือกโดยผู้จัดรายการเอง ให้นักเรียนส่งคำขอมาทางช่องทางโซเชียล
หริอกระทั่งให้นักเรียนหรือบุคคลที่สนใจมาส่งคำขอเพลงโดยตรงที่ห้องประชาสัมพันธ์เป็นต้น ซึ่งในแต่ละวิธีการก็มีข้อเสียต่าง ๆ เช่น

- **เลือกโดยผู้จัดรายการเอง** เพลงที่เปิดจากผู้จัดรายการอาจไม่มีความหลากหลาย นักเรียนซึ่งเป็นผู้ฟังไม่ได้มีส่วนร่วมการเลือกเพลง
- **ส่งคำขอทางช่องทางโซเชียล** คำขอเพลงที่ส่งเข้ามาอาจไม่มีความเป็นระเบียบเรียบร้อย รวบรวมและนำไปใช้ต่อได้ยาก
- **ส่งคำขอเพลงโดยตรงที่ห้องประชาสัมพันธ์** อาจรบกวนการจัดรายการของผู้จัดรายการในขณะนั้น

ผมจึงมีแนวคิดที่จะจัดทำเว็บไซต์สำหรับจัดการคำขอเพลงในรายการโดยเฉพาะ โดยตั้งอยู่บนหลักการสำคัญ 3 ข้อด้วยกัน

1. **ระบบจะต้องสามารถใช้งานได้ง่าย** มีรูปแบบการใช้งานที่เรียบง่าย เพื่อให้สามารถใช้งานได้กับทุกคน
2. **สามารถรวบรวมและนำเพลงไนระบบไปใช้ได้ต่อได้** ผู้จัดรายการจะต้องสามารถเรียกดูรายการคำขอเพลงที่ส่งเข้ามาได้ และสามารถนำเพลงไปค้นหาหรือเปิดต่อได้
3. **สามารถปฏิเสธเพลงที่ไม่เหมาะสมในระบบได้** การคัดกรองเนื้อหาก่อนจัดรายการมีความสำคัญมาก หากเพลงใดที่มีเนื้อหาไม่เหมาะสม ต้องสามารถปฏิเสธในระบบได้

## หลักการทำงาน

โครงการ PM Station เขียนด้วยภาษา TypeScript เป็นหลัก มีลักษณะของ Project เป็น Monorepo มีส่วนประกอบดังต่อไปนี้

### ส่วนที่ 1 การจัดการคำขอเพลง

ส่วนการจัดการคำขอเพลง เป็นส่วนประกอบหลักของ Project นี้ จัดทำเป็นเว็บไซต์โดยใช้ React Framework เป็น Remix
และเผยแพร่เว็บไซต์นี้ผ่านทางแพลตฟอร์ม Fly.io และ Vercel
เว็บไซต์นี้ทำหน้าที่รับคำขอเพลงจากผู้ใช้งาน และจัดการคำขอเพลงที่ได้รับโดยผู้จัดรายการและบุคคลที่เกี่ยวข้อง

<ResponsiveBanner />

#### 1. การเข้าสู่ระบบ

เว็บไซต์นี้ใช้ **Firebase Authentication** เป็นระบบตรวจสอบสิทธิ์ผู้ใช้งาน โดยตั้งค่าให้สามารถเข้าสู่ระบบโดยใช้หมายเลขโทรศัพท์ (Phone Login) ได้ ซึ่ง Firebase มีโควตาการใช้งานฟรี ทำให้ไม่เสียค่าใช้จ่ายแต่อย่างใด

เมื่อผู้ใช้งานเข้าสู่เว็บไซต์ จะปรากฏหน้าสำหรับป้อนเบอร์โทรศัพท์ และรับรหัส OTP ดังรูป

เมื่อเข้าสู่ระบบสำเร็จแล้ว ในครั้งแรกจะให้ผู้ใช้งานลงทะเบียนข้อมูลก่อน โดยประกอบด้วยชื่อ (`displayName`) และประเภทของผู้ใช้ (`type`) ส่วนตำแหน่งของผู้ใช้ (`role`) จะถูกตั้งค่าเริ่มต้นเป็นผู้ใช้งาน (User) ดังรูป

ประเภทและตำแหน่งของผู้ใช้ในระบบมีรายการดังต่อไปนี้

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-station/blob/main/packages/pm-station-shared/user.ts"
  startLine={3}
  endLine={10}
/>

ข้อมูลที่ได้จากการลงทะเบียนจะถูกจัดเก็บลงใน Token ของ Firebase Authentication ด้วย [Custom Claims](https://firebase.google.com/docs/auth/admin/custom-claims)
ซึ่งต่างจากผลงานชิ้นอื่น ๆ ที่มักจัดเก็บลงในฐานข้อมูลภายนอกอย่าง Firebase Firestore เนื่องจาก Remix นั้นเป็น React Framework ที่เน้นการ Render Page แบบ Server Side Rendering จึงต้องลดการเชื่อมต่อไปยังฐานข้อมูลโดยไม่จำเป็น

#### 2. การส่งคำขอเพลง

เมื่อผู้ใช้งานได้เข้าสู่ระบบแล้ว สามารถส่งคำขอเพลงสำหรับเปิดในรายการเข้าสู่ระบบได้ โดยในขณะทีพัฒนาเว็บไซต์นี้มีทางเลือกในการออกแบบฟีเจอร์นี้ 2 วิธี

1. **รับคำขอเพลงจากลิงก์ของผู้ให้บริการสตรีมมิง (เช่น YouTube)** วิธีการนี้ผู้ใช้งานจะต้องค้นหาเพลงในผู้ให้บริการภายนอก แล้วคัดลอกลิงก์มายังเว็บไซต์ แล้วเว็บไซต์จึงเรียกดูข้อมูลผ่านทาง API (เช่น Youtube Data API)
2. **ค้นหาเพลงในระบบผ่านทาง API ของผู้ให้บริการสตรีมมิง (เช่น Spotify)** วิธีการนี้เราสามารถกำหนดรูปแบบการแสดงผลในส่วนของการค้นหาได้ตามต้องการ ไม่จำเป็นต้องให้ผู้ใช้งานเปลี่ยนเว็บไซต์ไปยังผู้ให้บริการภายนอก

ผมได้เลือกวิธีการที่ 2 โดยเลือกเป็นผู้ให้บริการจาก Spotify ซึ่งนอกจากเหตุผลในการค้นหารายการเพลงแล้ว เหตุผลอีกข้อหนึ่งก็คือ การรับคำขอจากลิงก์ของผู้ให้บริการอย่าง YouTube ที่มีคลิปวิดีโอและเพลงจำนวนมากเป็นการเปิดอิสระแก่ผู้ใช้งานก็จริง แต่ก็ทำให้การคัดกรองเพลงนั้นยากขึ้นเช่นเดียวกัน

ส่วนติดต่อให้ผู้ใช้งานสามารถค้นหาเพลงและส่งคำขอเพลงได้จากภายในเว็บไซต์มีลักษณะดังนี้

ผู้ใช้งานสามารถค้นหาเพลงที่ต้องการได้ จากนั้นเลือกเพลงที่ต้องการ สามารถทดลองฟังโดยการกด Preview ได้ และกดปุ่ม "ส่งคำขอเพลง" เพื่อส่งคำขอเพลงไปยังระบบได้

ในการส่ง Request ไปยัง Spotify API นั้นมีการ Authorization ด้วย Access Token จึงมีการเขียนคำสั่งในส่วนนี้ไว้ด้วย โดยมี Diagram ดังต่อไปนี้

![Spotify Authorization Flow - Client Credentials](https://developer.spotify.com/images/documentation/web-api/auth-client-credentials.png)

เพื่อลดจำนวนครั้งในการ Issue Token ใหม่ในแต่ละครั้ง ผมจึงออกแบบให้สามารถจัดเก็บ Token ไว้ใน Redis เพื่อเป็นการ Caching และกำหนดให้ใช้ Token นี้หากยังไม่หมดอายุ
โดย Token นี้จะถูกจัดเก็บไว้ใน Upstash Redis ซึ่งเป็น Redis แบบ Serverless และมีโควตาการใช้งานฟรี ทำให้ไม่เสียค่าใช้จ่ายอีกเช่นกัน

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/utils/pm-station/spotify/auth.ts"
  startLine={36}
  endLine={65}
/>

หลักการทำงานของหน้าค้นหานี้คือการเรียกใช้ Spotify API เพื่อค้นหาเพลงโดยใช้ Endpoint `/search` ที่สามารถค้นหาได้จากชื่อเพลง หรือชื่อศิลปินก็ได้

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-station/blob/main/apps/client-web/app/utils/pm-station/spotify/search.ts"
  startLine={41}
  endLine={55}
/>

เมื่อผู้ใช้งานกดส่งคำขอเพลง ระบบจะบันทึกคำขอนี้ไว้ในฐานข้อมูล Firebase Firestore โดยบันทึกข้อมูล 2 ประเภทดังต่อไปนี้
เมื่อ `trackId` หมายถึงรหัส ID ของรายการเพลงจาก Spotify API และ `userId` หมายถึงรหัส ID ของผู้ใช้งานจาก Firebase Authentication

- **ข้อมูลเพลง (Record)** อยู่ที่ตำแหน่ง `songrequests/{trackId}` บันทึกข้อมูลเพลงที่ได้รับจาก Spotify API และเพิ่มเติมข้อมูลต่าง ๆ ที่จำเป็น
  เช่น จำนวนผู้ส่งคำขอ (`submissionCount`) วันที่เล่นล่าสุด (`lastPlayedAt`) เป็นต้น

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-station/blob/main/packages/pm-station-shared/schema/src/songrequests/schema.ts"
  startLine={12}
  endLine={35}
/>

- **ข้อมูลการส่งคำขอ (Submission)** อยู่ที่ตำแหน่ง `songrequests/{trackId}/submission/{userId}` บันทึกรายการคำขอเพลงจากผู้ใช้ ประกอบด้วยข้อมูลที่จำเป็น
  เช่น ส่งคำขอโดยใคร (`submittedBy`) เป็นต้น

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-station/blob/main/packages/pm-station-shared/schema/src/songrequests/schema.ts"
  startLine={37}
  endLine={41}
/>

สำหรับข้อมูลที่เกี่ยวกับการนับจำนวน และวันที่ ผมได้ใช้ Firebase Functions ในการกำหนดค่าเมื่อ Collection มีการเปลี่ยนแปลงโดยอัตโนมัติ เพื่อให้ได้ข้อมูลที่เป็นปัจจุบันมากที่สุด
และป้องกันข้อมูลบางรายการที่ส่งจากผู้ใช้งานซ้ำซ้อนกัน (Duplication)

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-station/blob/main/apps/pm-station-firebase/functions/src/handler.ts"
  startLine={24}
  endLine={48}
/>

โค้ดด้านบนนี้เป็นตัวอย่างใน Firebase Functions ที่จะดำเนินการดังต่อไปนี้เมื่อข้อมูลการส่งคำขอ (Submission) เปลี่ยนแปลงไป

- กำหนดเวลาที่แก้ไขล่าสุด (`lastUpdatedAt`) และจำนวนผู้ส่งคำขอทั้งหมดของเพลงที่ผู้ใช้งานส่งเข้าในระบบ
- กำหนดจำนวนคำขอสุทธิ (`submissionCount`) ลงใน Document `summary` ซึ่งบันทึกรายการสรุปของรายการคำขอและเพลงทั้งหมด

#### 3. การจัดการคำขอเพลง

ผู้ที่มีตำแหน่งผู้ใช้ตั้งแต่ Editor ขึ้นไป สามารถดูรายการคำขอเพลงจากผู้ใช้งานที่ส่งเข้ามาได้ เดิมทีข้อมูลในส่วนนี้ใช้การแสดงผลจากฐานข้อมูล Firebase Firestore เพียงอย่างเดียว ซึ่งสามารถจัดเรียง (Sort) และคัดกรองข้อมูล (Filter) ได้อย่างง่าย ๆ เท่านั้น แต่ต่อมาเมื่อรายการคำขอเพลงมีจำนวนมากขึ้น จึงมีการประยุกต์ใช้บริการ Search Engine จาก Algolia เพื่อให้สามารถค้นหาข้อมูลแบบ Full Text Search ได้ด้วย

การใช้งาน Algolia ร่วมกับ Firebase Firestore นั้น สามารถทำได้โดยการติดตั้งส่วนเสริม [Search with Algolia](https://extensions.dev/extensions/algolia/firestore-algolia-search) ซึ่งมีค่าใช้จ่ายในส่วนนี้เพียงเล็กน้อยเท่านั้น

ปัจจุบันส่วนการจัดการคำขอเพลงมีความสามารถดังต่อไปนี้

- จัดเรียงคำขอเพลงตามสถานะ "ยังไม่ได้เล่น" "เล่นแล้ว" หรือ "ถูกปฏิเสธ" ได้
- ปฏิเสธหรือยกเลิกการปฏิเสธเพลงที่เนื้อหาไม่เหมาะสมได้
- จัดเรียงคำขอเพลงตาม "ชื่อ" หรือ "วัน-เวลาส่ง" ได้
- สามารถค้นหาคำขอเพลงที่ต้องการได้ด้วยชื่อเพลง หรือชื่อศิลปินได้
- สามารถคัดกรองคำขอเพลงได้ตามจำนวนคำขอเพลง หรือศิลปินได้

ส่วนติดต่อในหน้านี้มีการประยุกต์ใช้ [React InstantSearch](https://www.algolia.com/doc/guides/building-search-ui/what-is-instantsearch/react-hooks/) ซึ่งเป็นชุด Components สำหรับออกแบบส่วนติดต่อการค้นหาและกรองข้อมูลจาก Algolia ทำให้สามารถประหยัดเวลาในการเขียนโค้ดไปได้มาก
