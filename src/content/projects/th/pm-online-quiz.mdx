---
title: PM Online Quiz (พอมอถามได้ตอบได้)
description: เว็บไซต์สำหรับโครงการพอมอถามได้ตอบไดั เพื่อให้นักเรียนได้ทดสอบความรู้ความสามารถทางวิชาการ ผ่านการทำแบบทดสอบประเมินความรู้
releaseDate: 2022-03-10
tags:
  - year 2564
  - website
image: /images/projects/pm-online-quiz/user-exam.jpg
gitUrl: https://github.com/coolkidssatit/pm-online-quiz
rating: 5
---

import GithubEmbed from "@/components/markdown/GithubEmbed.astro";
import ResponsiveBanner from "@/components/markdown/ResponsiveBanner.astro";

![PM Online Quiz User Exam](/images/projects/pm-online-quiz/user-exam.gif)

โครงการพอมอถามได้ตอบได้ เป็นโครงการจากคณะกรรมการนักเรียนฝ่ายวิชาการ ประจำปีการศึกษา 2564 โดยมีวัตถุประสงค์เพื่อ

- ให้ผู้เรียนมีทักษะในการอ่าน ฟัง พูด อ่าน เขียน เพื่อค้นคว้าหาความรู้เพิ่มเติม
- ส่งเสริมความสามารถในการคิดวิเคราะห์ในการทดสอบของผู้เรียน
- เพื่อเป็นการเตรียมความพร้อมในการสอบในระดับต่างๆ

โดยดำเนินการในรูปแบบของเว็บไซต์สำหรับให้นักเรียนเข้าทำแบบทดสอบ โดยแบ่งออกเป็น 2 ระดับชั้น ดังต่อไปนี้

1. **ระดับชั้นมัธยมศึกษา** เป็นแบบทดสอบความรู้และความสามารถทั่วไป โดยแบ่งแบบทดสอบออกเป็น 3 ชุด 3 กลุ่มสาระการเรียนรู้ ได้แก่ ภาษาไทย สังคมศึกษา และภาษาต่างประเทศ กลุ่มสาระการเรียนรู้ละ 35 ข้อ
2. **ระดับชั้นมัธยมศึกษาตอนปลาย** เป็นแบบทดสอบความรู้ระดับเดียวกับการสอบเข้ามหาวิทยาลัย ที่รวบรวมจากแบบทดสอบเก่าในช่วงหลายปีที่ผ่านมา โดยแบ่งแบบทดสอบออกเป็น 5 ชุด 5 กลุ่มสาระการเรียนรู้ ได้แก่
   - ภาษาไทย 50 ข้อ
   - สังคมศึกษา 50 ข้อ
   - คณิตศาสตร์ 30 ข้อ
   - วิทยาศาสตร์ 50 ข้อ
   - ภาษาต่างประเทศ 80 ข้อ

โครงการนี้เปิดให้นักเรียนเข้าทำแบบทดสอบตั้งแต่วันที่ 10 - 31 มีนาคม 2565 โดยผมได้มีส่วนร่วมในจัดทำโครงการนัี้ร่วมกับคณะกรรมการนักเรียน ประจำปีการศีึกษา 2564 ในส่วนของการจัดทำเว็บไซต์สำหรับสร้างและเข้าทำแบบทดสอบในโครงการ

## ที่มาของผลงาน

สืบเนื่องจากสถานการณ์การแพร่ระบาดของเชื้อไวรัส COVID-19 ทำให้ทุกโครงการของคณะกรรมการนักเรียนจำเป็นต้องจัดในรูปแบบออนไลน์ทั้งสิ้น โครงการนี้ก็เช่นเดียวกัน ผมจึงได้รับการทาบทามให้มาช่วยในการจัดทำเว็บไซต์นี้ด้วย

เมื่อพูดถึงตัวเลือกในการจัดทำแบบทดสอบออนไลน์ ตัวเลือกแรกของใครหลาย ๆ คนคือการใช้ Google Forms โดยแนวทางคือการรวมลิงก์ Google Forms และประชาสัมพันธ์ด้วยตนเอง แต่ Google Forms เป็นเว็บไซต์สำหรับการจัดทำ**แบบสอบถามหรือแบบสำรวจ** ไม่ได้ออกแบบมาสำหรับการจัดทำแบบทดสอบ

ขณะนั้นความต้องการสำหรับการจัดทำเว็บไซต์นี้มีอยู่หลายประการ อาทิเช่น

- แบบทดสอบสามารถจับเวลาในระหว่างการทำได้ (❌️ ไม่สามารถทำได้)
- แบบทดสอบสามารถแสดงผลข้อความที่ซับซ้อน เช่น สูตรคณิตศาสตร์ หรือบทความยาว ๆ ได้ (➖️ อาจสามารถทำได้ ใช้เป็นรูปภาพแทน)
- แบบทดสอบสามารถจัดทำได้ง่าย โดยไม่ใช้ Syntax ที่ยากและซับซ้อนจนเกินไป (✅️ มีส่วนติดต่อที่ใช้งานได้ง่ายและคุ้นเคย)
- แบบทดสอบสามารถสลับข้อได้ แต่ในบางชุดบางส่วนก็ไม่ต้องการให้สลับได้ เช่น ส่วนของการอ่านบทความ เป็นต้น (➖️ สลับลำดับข้อได้เฉพาะทั้งชุดแบบทดสอบ ไม่สามารถสลับเฉพาะส่วนได้)
- แบบทดสอบสามารถกลับมาทำใหม่ได้ หากเกิดปัญหาในการเชื่อมต่อ เช่น อินเทอร์เน็ตขัดข้อง เป็นต้น (➖️ สามารถทำได้หากเปิดใช้งาน Autosave แต่ผู้เข้าสอบจะสามารถออกจากหน้าเว็บที่จัดทำนี้ได้)

ตัวเลือกอื่น ๆ ในการใช้งานก็เช่น การใช้งานระบบ Learning Management System (LMS) อย่าง Moodle แต่การจะติดตั้งระบบดังกล่าวจำเป็นต้องใช้เซิร์ฟเวอร์ที่มีทรัพยากรและค่าใช้จ่ายจำนวนหนึ่ง อีกทั้งบางฟีเจอร์ก็ยังไม่สามารถตอบสนองต่อความความต้องการ

ด้วยข้อจำกัดนี้เอง ผมจึงมีแนวคิดในการออกแบบระบบที่สามารถจัดทำแบบทดสอบ (Editor) และแสดงผลแบบทดสอบ (Renderer) ได้ด้วย และนำไปแสดงผลในเว็บไซต์ที่เขียนขึ้นเอง ซึ่งจะกล่าวถึงในหัวข้อถัดไป

## หลักการทำงาน

เว็บไซต์นี้จัดทำโดยใช้ภาษา TypeScript เลือกใช้ Next.js เป็น React Framework สำหรับการพัฒนา
และเผยแพร่เว็บไซต์นี้ผ่านทางแพลตฟอร์ม Vercel และ Netlify

<ResponsiveBanner />

### ระบบข้อสอบ

สำหรับระบบข้อสอบนั้นผมได้รับแรงบันดาลใจจาก [Perseus](https://github.com/Khan/perseus) ซึ่งเป็นระบบที่ใช้ภายในแบบฝึกหัดของเว็บไซต์ [Khan Academy](https://khanacademy.org) และเขียนด้วย JavaScript (React) โดย Khan Academy เป็นเว็บไซต์คอร์สเรียนฟรีในรายวิชาต่าง ๆ ที่เป็นภาษาอังกฤษจำนวนมาก แต่ Perseus เพิ่งจะมีการเขียนใหม่และ Open-source ในกลางปี 2565 ขณะที่กำลังเขียนเว็บไซต์นั้น Perseus ยังเป็นเวอร์ชั่นเก่า (ดูตัวอย่างจาก Fork [ที่นี่](https://github.com/lemasc/perseus)) ที่ไม่ได้รับการดูแลตั้งแต่ปี 2561 จึงยังไม่สามารถใช้งานได้ ต้องเขียนใหม่ด้วยตนเอง

อย่างไรก็ดี โครงสร้างต่าง ๆ ที่ใช้ภายใน Perseus ก็ถูกนำมาใช้เป็นแกนหลัก ๆ ของระบบข้อสอบนี้เช่นเดียวกัน ส่วนประกอบสำคัญที่ใช้ในการจัดทำระบบข้อสอบมีดังนี้

- **Markdown** เพื่อให้การจัดทำแบบทดสอบสามารถทำได้โดยใช้ภาษาที่ง่าย แต่ยังสามารถขยายส่วนเสริมต่าง ๆ ได้ตามต้องการ ผมจึงเลือกใช้ภาษา Markdown ในการพิมพ์จัดทำแบบทดสอบ และใช้ Library เสริมในการแปลง Markdown เป็น HTML เช่น [`simple-markdown`](https://github.com/ariabuckles/simple-markdown)
- [**KaTeX**](https://katex.org/) เป็น Library สำหรับแสดงผลสูตรคณิตศาสตร์บนเว็บไซต์โดยใช้คำสั่งภาษา LaTeX
- [**TOAST UI Editor**](https://ui.toast.com/tui-editor) เป็นโปรแกรมแก้ไขและแสดงผล Markdown แบบ WYSIWYG โดยสามารถเพิ่มเติม Plugin เพื่อใช้คำสั่งพิเศษในการปรับแต่งผลลัพธ์การแสดงผลได้
- [**Zustand**](https://github.com/pmndrs/zustand) เป็น React Library สำหรับเก็บข้อมูล (State) ซึ่งเป็นองค์ประกอบสำคัญที่ทำให้ระบบข้อสอบมีประสิทธิภาพสูงแม้การแสดงผลแต่ละข้อจะมีความซับซ้อนมากก็ตาม

![PM Online Quiz Admin Overview](/images/projects/pm-online-quiz/admin-overview.gif)

ผลลัพธ์ที่ได้ คือระบบข้อสอบแบบ Multiple Choices (MCQ) หลายตัวเลือก ที่มีประสิทธิภาพสูงตัวหนึ่ง แต่ก็ยังสามารถปรับแต่งได้ตามความต้องการ โดยมีฟีเจอร์โดดเด่นต่าง ๆ อาทิเช่น

- การแสดงผลบนอุปกรณ์เคลื่อนที่แบบ Responsive ในทุกส่วนของแบบทดสอบ
- สามารถออกแบบการตรวจแบบทดสอบได้ทั้ง Client และ Server
- การแสดงผลสูตรคณิตศาสตร์ในตัวโจทย์ของแบบทดสอบ หรีอในแต่ละตัวเลือกได้

![Editor Markdown Features](/images/projects/pm-online-quiz/editor-features.png)

- การแสดงผล Passage หรือบทความ ควบคู่ไปกับแบบทดสอบ (และสามารถเลือกให้แสดงเฉพาะข้อที่ต้องการได้) ด้วยฟังก์ชัน **Content**
- การสลับข้อทั้งแบบทดสอบ หรือเฉพาะส่วนที่ต้องการ (เช่น การเติมคำ Fill in the blanks ไม่สามารถสลับข้อได้)
- สามารถอ้างอิงเลขข้อในแบบทดสอบได้ แม้จะต้องผ่านการสุ่มสลับข้อโดยระบบอีก

_ตัวอย่างในส่วนของการแสดงผล_

![Dynamic Item - Renderer](/images/projects/pm-online-quiz/dynamic-item-renderer.gif)

_ตัวอย่างในโปรแกรมแก้ไข_

![Dynamic Item - Editor](/images/projects/pm-online-quiz/dynamic-item-editor.gif)

ความสามารถเหล่านี้เกิดขึ้นได้จากโครงสร้างพื้นฐานว่า แบบทดสอบคือ **Section หลัก** ที่อาจประกอบด้วย **หลาย Section ย่อย ๆ** โดยใน Section ก็สามารถมี **หลาย ๆ ข้อ (Items)** ได้ ในแต่ละ Section (รวมถึงตัวแบบทดสอบเอง) จึงสามารถกำหนดค่าต่าง ๆ ได้โดยอิสระ ไม่กระทบซึ่งกันและกัน เช่น Section นี้ไม่สามารถสุ่มลำดับข้อได้ หรือ Section นี้มี Content นี้ตลอดในทุกข้อย่อย

![Sections - Editor](/images/projects/pm-online-quiz/admin-exam-sections.gif)


<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/types/exam.ts"
  startLine={8}
  endLine={14}
/>

ข้อมูลแบบทดสอบและเฉลยทั้งหมดถูกจัดเก็บและซิงก์ลงใน Firebase Firestore ซึ่งเป็นฐานข้อมูลแบบ NoSQL แต่บน Production จะใช้วิธีการบันทึกข้อมูลลงเป็นไฟล์ (Filesystem) เนื่องจากสามารถอ่านข้อมูลได้ง่ายกว่า และสามารถ Index จัดเรียงข้อมูลได้เอง

### การเข้าสู่ระบบ

เว็บไซต์นี้ใช้ **Firebase Authentication** เป็นระบบตรวจสอบสิทธิ์ผู้เข้าสอบ โดยตั้งค่าให้สามารถเข้าสู่ระบบโดยใช้บัญชี Google ของโรงเรียน (G Suite For Education) ดังรูป

![PM Online Quiz - Login](/images/projects/pm-online-quiz/login.png)

### การเข้าทำแบบทดสอบ

![PM Online Quiz - Home](/images/projects/pm-online-quiz/home.png)

เมื่อเข้าสู่ระบบแล้ว ระบบจะแสดงข้อมูลแบบทดสอบ ดังนี้

- **แบบทดสอบที่สามารถทำได้** แบ่งตามระดับชั้น สถานะ (ยังไม่ได้เข้าสอบ หรือ กำลังสอบอยู่) และระยะเวลาในการสอน (ถ้ามี)
- **ประวัติการทำแบบทดสอบ** แสดงคะแนนที่ได้ และวันที่และเวลาที่ส่งแบบทดสอบ

เมื่อคลิกที่แบบทดสอบที่สามารถเข้าสอบได้ ระบบจะแสดงคำชี้แจงก่อนเข้าทำแบบทดสอบ ดังรูป

![PM Online Quiz - Exam Instructions](/images/projects/pm-online-quiz/instructions.png)

เมื่อคลิกที่ปุ่ม **เริ่มทำแบบทดสอบ** ระบบจะส่งคำขอไปยัง API เพื่อเริ่มต้นหรือกู้คืน **Session** ในการทำแบบทดสอบ

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/exam/%5Bpath%5D/index.tsx"
  startLine={12}
  endLine={20}
/>

Session ในการทำแบบทดสอบ มีเงื่อนไขดังต่อไปนี้

- Session การทำแบบทดสอบ จะสิ้นสุดก็ต่อเมื่อผู้เข้าสอบกดส่งแบบทดสอบ หรือหมดเวลาการทำแบบทดสอบ
- Session จะยังคงอยู่หากออกจากเว็บไซต์ หรือปิดเบราว์เซอร์ปัจจุบัน
- ในการ Login 1 ครั้ง สามารถทำแบบทดสอบกี่ชุดก็ได้ ตราบใดที่ Session ในแต่ละแบบทดสอบยังไม่สิ้นสุด
- Session ไม่สามารถโอนข้ามเบราวเซอร์หรืออุปกรณ์ได้ (เปิดเครื่องอื่นจะเสมือนเริ่มทำแบบมทดสอบใหม่)

ในส่วนนี้มีรายละเอียดทาง Technical ค่อนข้างมาก สามารถอธิบายทีละส่วนได้ดังนี้

#### การบันทึกข้อมูลในระหว่างการทำแบบทดสอบ

การทำงานของเว็บไซต์บนแพลตฟอร์ม Serverless อย่าง Vercel นั้น เว็บไซต์จะไม่มีเซิร์ฟเวอร์เป็นของตนเอง แต่สำหรับคำขอที่จำเป็นต้องใช้เซิร์ฟเวอร์ในการประมวลผลแต่ละครั้ง (เช่น API Routes) แพลตฟอร์มจะเรียกใช้คำสั่งขนาดเล็กที่เขียนขึ้นเรียกว่า Lambda เพื่อมาประมวลผล จากนั้นเมื่อเสร็จสิ้น Lambda จะถูกหยุดและปิดใช้งานลงไป ดังนั้นข้อมูลใด ๆ ที่บันทึกจะอยู่เฉพาะใน Lambda ที่ประมวลผลอยู่เท่านั้น เมื่อเสร็จสิ้นข้อมูลที่บันทึกไว้ก็จะหายไป

ในแต่ละการทำแบบทดสอบ จำเป็นต้องมีการตรวจสอบสถานะของผู้ใช้อย่างต่อเนื่อง ว่าผู้ใช้ที่กำลังเข้าสอบนี้เป็นผู้ใช้รายเดียวกันหรือไม่ เริ่มเข้าสอบเมื่อไหร่ และสิ้นสุดการสอบเมื่อไหร่ ข้อมูลเหล่านี้มีการเรียกใช้ถี่มาก ๆ หากจะเก็บข้อมูลลงในฐานข้อมูลจากบริการภายนอกอย่าง Firebase Firestore ก็จะมีโควต้าการใช้งานที่สูง เนื่องจาก Firestore คิดค่าบริการเป็นต่อ 1 คำขออ่าน/เขียน

ตัวเลือกในขณะนั้นคือการเก็บข้อมูลลงใน Cookie ของผู้ใช้ โดยการเข้ารหัสด้วย Library อย่าง [**Iron Session**](https://github.com/vvo/iron-session) ซึ่งเป็น Library สำหรับการจัดเก็บข้อมูลและเข้ารหัสลงใน Cookie ทำให้สามารถอ่าน-บันทึกข้อมูลจากเว็บไซต์มายังผู้ใช้ได้แบบ Stateless (ไม่จำเป็นต้องมีการบันทึกข้อมูลใด ๆ ที่ฝั่งเซิร์ฟเวอร์) โดยจุดอ่อนของวิธีการนี้มี 2 ข้อ

- **ผู้เข้าสอบสามารถปิดใช้งานหรือลบคุกกี้เพื่อล้างสถานะทั้งหมดได้** แต่ผู้เข้าสอบที่เลือกลบคุกกี้ก็ต้องยอมรับความเสี่ยงเอง ถือว่าการทำแบบทดสอบนั้นไม่เสร็จสิ้น
- **คุกกี้มีความยาวที่จำกัด ดังนั้นสามารถจัดเก็บข้อมูลได้จำกัด** สามารถใช้เทคนิคต่าง ๆ เพื่อปรับปรุงประสิทธิภาพการจัดเก็บข้อมูลได้ (จะกล่าวถึงในหัวข้อถัดไป)

ดังนั้น การจัดเก็บข้อมูลและสถานะการเข้าทำแบบทดสอบจึงถูกบันทึกลงใน Cookie ของผู้เข้าสอบ และเมื่อทำแบบทดสอบเสร็จสิ้นข้อมูลใน Cookie ก็จะถูกล้างออกไป

การใช้ Iron Session จะเป็นการบันทึกข้อมูลลงใน Cookie พร้อมกับเข้ารหัสแบบ Symmetric Encryption ด้วย Password ที่เซิร์ฟเวอร์รู้เท่านั้น จึงมีความปลอดภัยสูง ไม่สามารถปลอมแปลงโดยผู้ใช้งานได้

> ปัจจุบันขณะที่เขียนหน้านี้ Solution ทางเลือกในการเก็บข้อมูลจากฝั่ง Serverless คือการใช้ฐานข้อมูลแบบ Key-Value
> อย่าง Redis หรือ Cloudflare KV ซึ่ง Redis มีผู้ให้บริการที่เป็น Serverless อย่าง [Upstash Redis](https://upstash.com/) ด้วย
>
> ผมได้นำไปประยุกต์ใช้กับผลงานต่อไปอย่าง [เว็บไซต์วิทยุเสียงตามสาย PM Station](/projects/pm-station) ในการจัดเก็บข้อมูล Token

#### การเริ่มต้น (Start) Session การทำแบบทดสอบ

ในการเริ่มต้นทำแบบทดสอบแต่ละครั้ง สิ่งที่เกิดขึ้นหลัก ๆ คือการสุ่มลำดับข้อในแบบทดสอบ โดยจะต้องบันทึกข้อมูลทั้งหมดไว้ใช้ในภายหลังเพื่อให้สามารถตรวจคำตอบได้

ในแบบทดสอบแต่ละข้อเมื่อนำมารวมกันจะมีลักษณะข้อมูลเป็น Array หากเป็นระบบทั่วไปก็สามารถใช้ฟังก์ชันในการสลับลำดับของ Array ได้เลย แต่เนื่องจากในระบบปัจจุบัน แบบทดสอบมีลักษณะเป็นหลาย Section ย่อย ๆ จึงมีความจำเป็นต้องเขียนคำสั่งแบบ Recursive Function ที่จะประมวลผลเป็นซ้ำและลึกลงเรื่อย ๆ กล่าวให้เห็นภาพคือ แบบทดสอบหลัก (Main Section) จะประมวลผล Section ย่อย ๆ ไปเรื่อย ๆ จนกว่าจะไม่มี Section ใด ๆ เหลืออยู่

ในการประมวลผลโดยระบบ 1 ข้อที่สมบูรณ์ จะเรียกว่า **1 Hash Item** ซึ่งจะมีโครงสร้างดังต่อไปนี้

<div class="max-w-full">
<div class="flex flex-row items-center lg:justify-center bg-gray-100 p-4 rounded-lg overflow-x-auto">
  <span class="font-medium flex-shrink-0 rounded-2xl px-6 py-2 bg-red-200 text-red-800">
    Main Section
  </span>
  <span class="text-2xl px-2">~</span>
  <span class="font-medium flex-shrink-0 rounded-2xl px-6 py-2 bg-green-200 text-green-800">
    Section A (ถ้ามี)
  </span>
  <span class="text-2xl px-2">~</span>
  <span class="font-medium flex-shrink-0 rounded-2xl px-6 py-2 bg-green-200 text-green-800">
    Section B (ถ้ามี)
  </span>
  <span class="text-2xl px-2">~</span>

  <span class="font-medium flex-shrink-0 rounded-2xl px-6 py-2 bg-blue-200 text-blue-800">
    เลขข้อ (A-Z)
  </span>
</div>
</div>

ยกตัวอย่างเช่น หากข้อสอบมี ID ว่า `EXAM` และมี Section ย่อย A ที่มี ID เป็น `GRAMMAR` จะสามารถได้ Hash Item ของข้อที่ 1 คือ `EXAM~GRAMMAR~A` เป็นต้น

แต่ในสถานการณ์จริงเนื่องจากข้อมูลถูกบันทึกไว้ใน Firestore Firebase จึงได้ ID ที่มีความยาวตัวอักษรมาก เช่น `rabViBBh3ExNw7rwElUXA` ดังนั้น เพื่อประหยัดพื้นที่การจัดเก็บข้อมูล จึงมีการสร้าง Hash ของ ID ที่มีความยาวสั้นกว่า และเก็บไว้เป็นข้อมูลกลาง เสมือนเป็นชื่อเล่น ดังนั้น แทนที่จะเรียก ID จาก Firestore ที่ยาวมาก ๆ เราก็ใช้ Hash ที่มีความยาวสั้นกว่าแทน

ผมเลือกใช้ Library ที่ชื่อ [nanoid](https://github.com/ai/nanoid) ในการสุ่มตัวอักษรขึ้นเพื่อเป็นค่า Hash โดยเลือกความยาวที่ไม่ยาวจนเกินไป แต่ก็ไม่สั้นจนเกินไปจนมีโอกาสได้ค่าที่จะซ้ำกัน ในที่นี้คือ 4 ตัวอักษร

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/start.ts"
  startLine={46}
  endLine={48}
/>

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/start.ts"
  startLine={39}
  endLine={44}
/>

เมื่อได้ Hash Item ของ Section ที่กำลังประมวลผลอยู่ในขณะนั้น ก็สามารถสลับลำดับข้อได้เลย แล้วจึงแยกประมวลผล Section ย่อย ๆ 

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/start.ts"
  startLine={76}
  endLine={88}
/>

เราไม่สามารถสลับลำดับข้อในขั้นตอนสุดท้ายได้ เพราะมีความเป็นไปได้ว่า Section ย่อยที่ไม่ต้องการให้ถูกสลับข้อนั้นจะถูกสลับไปด้วย (สามารถพิสูจน์ได้ด้วยกฏการสลับที่ทั่วไป)

ตารางของค่า Hash และ Firebase Document ID จะถูกเก็บเข้ารหัสไว้ใน Session Cookie รวมถึงข้อมูลอื่น ๆ เช่น เวลาเริ่มต้นและสิ้นสุดการทำแบบทดสอบด้วย

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/start.ts"
  startLine={98}
  endLine={112}
/>

ส่วนข้อมูลที่สามารถส่งกลับไปยังผู้เข้าสอบได้คือ

- ลำดับข้อของแบบทดสอบ (ซึ่งเป็น Hash Item จึงเสมือนว่า Obfuscate ปกปิดมาแล้วชั้นหนึ่ง)
- รายการ Section ในแบบทดสอบที่จำเป็นต้องเรียกดู Content (เนื้อหาหรือบทความ)
- ชื่อของ Section ในแบบทดสอบที่ต้องแสดงผลแก่ผู้เข้าสอบ

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/start.ts"
  startLine={127}
  endLine={132}
/>

ข้อมูลแบบทดสอบที่ได้รับจาก API จะถูกบันทึกลงใน `localStorage` เพื่อเก็บไว้ใช้งานบนเบราวเซอร์ต่อไป

#### การกู้คืน (Restore) Session การทำแบบทดสอบ

ระบบถูกออกแบบมาให้สามารถกู้คืนสถานะการทำแบบทดสอบได้ หาก Session ยังไม่หมดอายุ โดยในการกู้คืน Session จำเป็นต้องส่งข้อมูลแบบทดสอบจาก `localStorage` ไปด้วย เนื่องจากข้อมูลใน `localStorage` สามารถแก้ไขได้โดยจากฝั่งเบราวเซอร์เช่นกัน จึงมีการตรวจสอบก่อนว่าเป็นไปตามรูปแบบที่ถูกต้องหรือไม่

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/exam/%5Bpath%5D/index.tsx"
  startLine={22}
  endLine={31}
/>

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/restore.ts"
  startLine={26}
  endLine={31}
/>

อย่างไรก็ตาม API จะตรวจสอบเพียงแต่ข้อมูลแบบทดสอบนั้นมีโครงสร้างที่ถูกต้อง แต่ไม่ได้ตรวจสอบว่าข้อมูลแบบทดสอบนั้นมีข้อมูลที่ถูกต้องตรงกัน ในส่วนนี้จะถูกจัดการโดย API อื่น ๆ อยู่แล้ว

#### การเรียกดู Item / Content ของแบบทดสอบ

การเรียกดู Item และ Content ผมเลือกใช้ Library [SWR](https://swr.vercel.app/) ซึ่งเป็น React Library สำหรับเรียกดูข้อมูลจาก API โดย Library นี้มีการจัดการในส่วนของการเรียกดูข้อมูลใหม่หากเกิดปัญหา (Retry on Error) การ Refresh ข้อมูล (Mutate) การทำสถานะกำลังโหลด (Loading Status) และที่สำคัญคือการ Prefetch ข้อมูลไว้ล่วงหน้า ซึ่งทำให้การโหลดข้อมูลในแต่ละข้อนั้นไวขึ้น

เมื่อผู้เข้าสอบอยู่ที่แบบทดสอบข้อที่ 10 ระบบจะ Prefetch ข้อก่อนหน้า (10 - 1 = 9) และข้อถัดไป (10 + 1 = 11) ดังนั้นหากผู้เข้าสอบทำแบบทดสอบเรียงตามลำดับข้อไปเรื่อย ๆ ข้อมูลในแต่ละข้อจะสามารถโหลดได้อย่างรวดเร็ว

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/shared/remoteExam.ts"
  startLine={128}
  endLine={132}
/>

เว็บไซต์จะส่งคำขอ API พร้อมกับส่งค่า Hash Item ไปยังเซิร์ฟเวอร์ เซิร์ฟเวอร์แปลงค่า Hash Item กลับเป็น Firebase Document ID ดังที่กล่าวมาเมื่อสักครู่ และตอบกลับด้วยข้อมูลที่ถูกต้อง

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/shared/remoteExam.ts"
  startLine={78}
  endLine={87}
/>

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/%5Btype%5D/%5Bitem%5D.ts"
  startLine={25}
  endLine={34}
/>

#### การบันทึกคำตอบอัตโนมัติ

การบันทึกคำตอบในระหว่างการทำแบบทดสอบจะอยู่เฉพาะในฝั่งเบราวเซอร์เท่านั้น เพื่อลดการเชื่อมต่อไปยังเซิร์ฟเวอร์ และทำให้การโหลดข้อมูลคำตอบไวขึ้น โดยจัดเก็บข้อมูลลง `localStorage` เช่นเดียวกัน

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/exam/%5Bpath%5D/view.tsx"
  startLine={163}
  endLine={183}
/>

#### การตรวจสอบเวลาในการทำแบบทดสอบ

ส่วนนี้เป็นส่วนที่มีความท้าท้ายมากส่วนหนึ่งเลยทีเดียว ในระหว่างระยะเวลาการทำแบบทดสอบ (เช่น 90 นาที) จำเป็นต้องมีการตรวจสอบเวลาในการทำแบบทดสอบอยู่เสมอว่าถึงเวลาสิ้นสุดการสอบแล้วหรือไม่ โดยต้องออกแบบระบบให้สมดุลระหว่างความถูกต้องแม่นยำ และประสิทธิภาพของเซิร์ฟเวอร์ด้วย

ผมยึดหลักการว่า **เราไม่สามารถเชื่อใจ Client ได้ (Don't trust the client)** การตรวจสอบเวลาทั้งหมดจึงเกิดขึ้นบนเซิร์ฟเวอร์ เซิร์ฟเวอร์จะส่งกลับเพียงระยะเวลาที่คงเหลืออยู่ (Time left)

ใน API ที่มีการเรียกใช้บ่อย ๆ เช่น API ในการเรียกดู Item ในแต่ละข้อ จำเป็นต้องมีการตรวจสอบเวลาในทำแบบทดสอบอยู่แล้ว โดยหากหมดเวลาในการทำแบบทดสอบ คำขอ API ใด ๆ จะถูกตอบกลับด้วย HTTP Status 402

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/shared/api/index.ts"
  startLine={132}
  endLine={141}
/>

หากยังไม่หมดเวลาในการทำแบบทดสอบ ระบบจะส่ง Header `X-Exam-Time` ซึ่งระบุระยะเวลาที่คงเหลืออยู่ (เป็น milliseconds) กลับไปยัง Client ด้วย

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/shared/api/index.ts"
  startLine={144}
  endLine={153}
/>

อย่างไรก็ตามฝั่ง Client ก็ยังไม่สามารถใช้เวลาที่ได้รับนี้ทันที เนื่องจากมี Latency ที่เกิดจากเวลาไป-กลับในการส่งคำขอไปยังเซิร์ฟเวอร์ เนื่องจากผมใช้ Axios ในการทำ HTTP Request ไปยัง API อยู่แล้ว ดังนั้นผมจึงใช้ฟังก์ชัน [Interceptors](https://axios-http.com/docs/interceptors) เพื่อเขียนคำสั่งเพิ่มเติมก่อนและหลังส่งคำขอได้

ในส่วนของขาไป ก่อนจะส่ง Request จะมีการเก็บเวลาเริ่มต้นของ Request นี้ (`startRequest`) ก่อน

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/shared/timer.ts"
  startLine={64}
  endLine={73}
/>

ในส่วนของขากลับ จะมีการบันทึกเวลาที่ Request นี้เสร็จสิ้น (`lastConnect`) ตรวจสอบ Header `X-Exam-Time` ถึงระยะเวลาการสอบที่คงเหลือ (`examTime`) และคำนวน Latency จากระยะเวลาการส่ง Request ทั้งไปและกลับ จากนั้นนำมารวมเข้ากับระยะเวลาการสอบที่คงเหลือจริงก็จะได้เวลาที่ถูกต้อง (`timePending`)

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/shared/timer.ts"
  startLine={113}
  endLine={118}
/>

ส่วนถ้าเกิด Error ในระหว่างการส่ง Request ระบบก็จะตรวจสอบก่อนว่ามี HTTP Status 402 หรือไม่ หากมี ก็จะถือว่าเป็นการหมดเวลาและแจ้งเตือนแก่ผู้เข้าสอบทันที

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/shared/timer.ts"
  startLine={81}
  endLine={92}
/>

นอกจากนี้ หากไม่มีการส่งคำขอไปยัง API เป็นเวลานาน (ผู้เข้าสอบยังอยู่ในเว็บไซต์ แต่ไม่ได้ทำแบบทดสอบ) ระบบก็ยังมีการส่งคำไปยัง API เฉพาะ `/time` ที่มีหน้าที่แค่ตรวจสอบเวลาอย่างเดียวเท่านั้น ไม่ส่งข้อมูลใด ๆ กลับไป

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/shared/timer.ts"
  startLine={46}
  endLine={53}
/>

จากโค้ด ระบบจะตั้งเวลาเรียกคำขอ API หากไม่มีการเคลื่อนไหวเป็นเวลา 5 นาที อย่างไรก็ตามหากมี Request อื่น ๆ เกิดขึ้นตามมา การตั้งเวลานี้ก็จะถูกยกเลิกไป

#### การส่งแบบทดสอบ

เมื่อมีการส่งแบบทดสอบไปยัง API ระบบก็จะตรวจสอบและประมวลผลคำตอบที่เลือกเมื่อเทียบกับเฉลยของแบบทดสอบ

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/submit.ts"
  startLine={35}
  endLine={49}
/>

จากนั้น จึงคำนวนคะแนน และจัดเก็บข้อมูลต่าง ๆ ลงบน Firebase Firestore เพื่อเก็บข้อมูลการทำแบบทดสอบของผู้เข้าสอบ

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/submit.ts"
  startLine={51}
  endLine={67}
/>

จะสังเกตได้ว่า ผมมีการบันทึกตารางค่า `hash` และคำตอบ `answers` ของผู้เข้าสอบเอาไว้ด้วย เนื่องจากในเว็บไซต์มีฟีเจอร์ **พิมพ์สำเนาข้อสอบ** ด้วย ซึ่งจะอธิบายในหัวข้อต่อ ๆ ไป

### การรายงานผลการทดสอบ

![PM Online Quiz - Report Page](/images/projects/pm-online-quiz/report.png)

เมื่อผู้เข้าสอบทำแบบทดสอบเสร็จสิ้นแล้ว จะเข้าสู่หน้ารายงานผลการทดสอบ ซึ่งจะระบุรายละเอียดเกี่ยวกับการทำแบบทดสอบ และปุ่มสำหรับ **พิมพ์สำเนาข้อสอบ** และ **ดาวน์โหลดเกียรติบัตร**

ใน API หลัก ๆ ส่วนมากจะยืนยันตัวตนด้วยการใช้ Firebase Authentication Token โดยส่งคำขอ HTTP Request เป็น POST และแนบ Header `Authorization` ไปด้วย แต่จากประสบการณ์ที่ผ่านมาคำสั่งที่ต้องใช้การดาวน์โหลดหรือพิมพ์นั้นไม่ควรใช้ HTTP Request เป็น POST เพราะข้อมูลที่ส่งจะหายใน 2 กรณีดังต่อไปนี้

- การกด Refresh หน้าเว็บในเบราวเซอร์ (เบราวเซอร์อาจแสดงข้อความเตือน) ซึ่ง Header ที่ส่งไปอาจจะอยู่หรือหายก็ได้
- การเข้าเว็บไซต์จาก In App Browser (เช่น Facebook, LINE) บนอุปกรณ์มือถือ ระบบจะเปิดหน้าเว็บนี้ใหม่ในเบราวเซอร์ของอุปกรณ์ ซึ่ง Header ที่ส่งไปจะหายไป

ด้วยเหตุนี้เอง แต่ละคำสั่งจึงจำเป็นต้องแนบ Token เข้ากับ Query Parameter บน URL แทน

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/exam/%5Bpath%5D/report.tsx"
  startLine={67}
  endLine={76}
/>

สังเกตได้ว่ามีการใช้ค่า `downloadToken` แทนที่จะใช้เป็น Firebase Token โดยตรง เนื่องจาก Firebase Token เป็น Token แบบ JWT ซึ่งมีความยาวมากเกือบ 1,200 ตัวอักษร จึงเขียนคำสั่งในฝั่ง Server ขณะที่แสดงรายการแบบทดสอบให้สร้าง Token ที่ประกอบด้วยข้อมูลที่จำเป็นเท่านั้น โดยใช้ฟังก์ชัน จึงใช้ฟังก์ชัน `sealData` ซึ่งอยู่ภายใน Iron Session เพื่อเข้ารหัสในลักษณะเดียวกัน และได้ความยาวที่สั้นกว่าเป็นราว ๆ 350 ตัวอักษร

<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/list.ts"
  startLine={43}
  endLine={46}
/>

### การพิมพ์สำเนาข้อสอบ

เมื่อกดที่ปุ่ม **พิมพ์สำเนาข้อสอบ** ระบบจะสร้างไฟล์สำหรับการพิมพ์ข้อสอบ รวมทั้งตัวเลือกที่ผู้เข้าสอบเลือกตอบด้วย

![PM Online Quiz - Printout Page](/images/projects/pm-online-quiz/printout.gif)

การพิมพ์สำเนาข้อสอบเป็นคำสั่งที่ใช้ทรัพยากรทั้งฝั่ง Server และ Client มากพอสมควร เนื่องจากฝั่ง Server จำเป็นต้องอ่านข้อมูลและเรียงข้อทั้งหมด รวมทั้งฝั่ง Client จำเป็นต้องสร้าง Static HTML ในทุก ๆ ข้อเพื่อนำมาแสดงผลรวมกันด้วย เนื่องจากในขณะที่ออกแบบระบบข้อสอบนั้น ระบบข้อสอบออกแบบมาสำหรับแสดงผล 1 ข้อต่อ 1 หน้าเท่านั้น ไม่สามาารถทำพร้อม ๆ กันในลักษณะคู่ขนาน (Parallel) ได้ จึงต้องประมวลผลทีละข้อ แม้จะปรับให้รวดเร็วกว่าการแสดงผลข้อสอบปกติแต่ก็ยังใช้เวลาอยู่ดี

![PM Online Quiz - Printout Render Process](/images/projects/pm-online-quiz/printout-render.gif)

_เหตุการณ์ที่เกิดขึ้นในเบื้องหลังของ Loading Spinner คือการ Render และดึง HTML จาก Toast UI Editor ซึ่งในแบบทดสอบที่มีจำนวน 80 ข้อ พร้อม Content ในหลาย Section ใช้เวลาราว ๆ 15 วินาที_

### การดาวน์โหลดเกียรติบัตร

![PM Online Quiz - Cerificate Download](/images/projects/pm-online-quiz/certificate.gif)

เมื่อกดที่ปุ่ม **ดาวน์โหลดเกียรติบัตร** ระบบจะสร้างไฟล์เกียรติบัตรจากแม่แบบ (Template) ที่เป็นรูปภาพ ซึ่งมีการเว้นพื้นที่ไว้สำหรับกรอกข้อมูล ได้แก่ ชื่อ-นามสกุลผู้ทำแบบทดสอบ รายวิชาที่ทำแบบทดสอบ และคะแนนที่ได้จากการทำแบบทดสอบ แล้วส่งออกเป็นไฟล์ PDF โดย Library ในการจัดทำไฟล์ PDF ที่เลือกใช้คือ [PDFKit](https://pdfkit.org/)


<GithubEmbed
  file="https://github.com/coolkidssatit/pm-online-quiz/blob/main/pages/api/exam/%5Bid%5D/certificate.ts"
  startLine={26}
  endLine={33}
/>

ข้อสังเกตในการสร้าง PDF นี้คือการเข้ารหัสไฟล์ เนื่องจากไม่ต้องการให้ผู้ที่ได้รับ PDF สามารถแก่ไขไฟล์ด้วยโปรแกรมแก้ไข PDF ต่าง ๆ ได้ จึงมีการกำหนด Permission ในไฟล์ไว้ แล้วเข้ารหัสด้วย Password ซึ่ง Password จะถูกสุ่มขึ้นเช่นเดียวกัน ด้วยเหตุนี้เองตัวเซิร์ฟเวอร์เองก็ไม่สามารถถอดรหัสได้ กลายเป็น PDF ที่สามารถอ่านได้อย่างเดียวเท่านั้น

## ผลที่ได้รับจากการทำผลงาน

เว็บไซต์ได้มีการติดตั้งตัวติดตาม (Tracker) จาก [LogRocket](https://logrocket.com/) ประกอบกับข้อมูลที่บันทึกลงใน Firestore เมื่อผู้เข้าสอบเริ่มและสิ้นสุดการทำแบบทดสอบ โดยจากข้อมูลนักเรียนที่ลงทะเบียนในระบบ **57 คน** สามารถสรุปเป็นข้อมูลการเข้าทำแบบทดสอบตั้งแต่วันที่ 10 - 31 มีนาคม 2565 ได้ดังนี้

![PM Online Quiz - Submission Graph](/images/projects/pm-online-quiz/graph-submission.png)

รายวิชาที่มีผู้เข้าสอบทำแบบทดสอบมากที่สุด คือ วิชาภาษาไทย (ระดับชั้นมัธยมศึกษา) อยู่ที่ 19 คน ส่วนรายวิชาที่มีผู้เข้าสอบทำแบบทดสอบน้อยที่สุด คือ วิชาสังคมศึกษา (ระดับชั้นมัธยมศึกษาตอนปลาย)

ในส่วนของปัญหาการใช้งาน มีปัญหาจากการโหลด Passage ควบคู่ไปกับโจทย์ เนื่องจากตั้งค่า Section ซ้ำซ้อนกัน (Section ก่อนหน้ามี Content และมี Section ด้านในที่มี Content อีก) ในส่วนนี้ถือเป็น User Error และระบบไม่ได้แจ้งเตือน ผู้เข้าสอบที่ได้รับผลกระทบจึงได้คะแนนฟรีในข้อที่เกิดปัญหาไป

## สิ่งที่ได้เรียนรู้จากการทำผลงาน

ผลงานนี้เป็นผลงานที่มีความซับซ้อนมากที่สุดผลงานหนึ่งเลยก็ว่าได้ โดยเฉพาะในระบบข้อสอบมีการเขียน Logic ที่กำหนดขึ้นเองหลายส่วน ทำให้การกลับมาอ่านนั้นต้องใช้เวลาทำความเข้าใจไม่น้อยเลย แม้จะมีการจัดระเบียบไฟล์ไว้ระดับนึงแล้วก็ตาม 

ผลงานนี้มีการใช้เทคนิคต่าง ๆ เพื่อปรับปรุงประสิทธิภาพ (Optimization) อยู่หลายอย่าง เมื่อโค้ดมีความซัับซ้อนขึ้น การค้นหาข้อผิดพลาดที่เกิดขึ้นก็สามารถทำได้ยากขึ้นตามไปด้วย หากไม่ทำการ Optimize ให้ดีเว็บไซต์อาจจะหน่วงลงหรือค้างไปเลยได้

นอกจากนี้ ยังมีการปรับปรุงการเขียนโค้ดให้มีแก้ไขง่ายขึ้น ด้วยการรวมคำสั่งที่ใช้เหมือน ๆ กันไว้ในทีเดียว เช่น การ Extend Class หรือการทำ Higher Order Function (HOF) เป็นต้น

## ปัญหาและอุปสรรคที่เกิดขึ้น

ผมมีเวลาในการทำเว็บไซต์นี้ประมาณ 1 เดือน เนื่องจากเว็บไซต์นี้ด้วยความที่มีความซับซ้อนมาก จึงใช้ระยะเวลาในการทำที่มากตามไปด้วย เดิมทีเว็บไซต์นี้มีแผนเปิดตัวในช่วงสัปดาห์แรกของเดือนมีนาคม ก่อนการสอบ **GAT-PAT** ของนักเรียนชั้นมัธยมศึกษาปีที่ 6 เพื่อให้นักเรียนได้เตรียมตัวก่อนการสอบจริง แต่เนื่องจากมีปัญหาด้านความคืบหน้าของเว็บไซต์ทำให้มีการเลื่อนการเปิดตัวเว็บไซต์ออกไป 1 สัปดาห์ จึงทำให้ผู้เข้าสอบในระบบมีจำนวนน้อยกว่าที่คาดการณ์ไว้ ซึ่งเกิดจากการประมาณเวลาในการพัฒนาเว็บไซต์ รวมทั้งฟีเจอร์ต่าง ๆ ที่มีหลายส่วนด้วย ดังนั้นในผลงานต่อ ๆ ไป จึงต้องมีการวางแผนระยะเวลาในการทำผลงานให้ดีขึ้นกว่านี้นี้
